<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="assets/css/choosegamepage.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Choose Game</title>
  </head>
  <body>
    <video autoplay muted loop id="bg-video">
      <source src="assets/img/vinyles.mp4" type="video/mp4" />
    </video>
    <div class="container">
      <input type="radio" name="slider" id="item-1" checked />
      <input type="radio" name="slider" id="item-2" />
      <input type="radio" name="slider" id="item-3" />
      <div class="cards">
        <label class="card" for="item-1" id="song-1">
          <img src="assets/img/blindtest.png" alt="BlindTest" />
          <span class="card-text">BLINDTEST</span>
          <button id="creaBtBtn" class="hidden-btn crea" style="display:none;">Create</button>
          <script>
            document.getElementById("creaBtBtn").onclick = function () {
              document.getElementById("settingsPanel").style.display = "flex";
              document.getElementById("createSettings").style.display = "flex";
              document.getElementById("joinSettings").style.display = "none";
              document.getElementById("blindtestSettings").style.display = "flex";
              document.getElementById("deafTestSettings").style.display = "none";
              document.getElementById("scattegoriesSettings").style.display = "none";
            };
          </script>
          <button id="joinBtBtn" class="hidden-btn join" style="display:none;">Join</button>
          <script>
            document.getElementById("joinBtBtn").onclick = function () {
              document.getElementById("settingsPanel").style.display = "flex";
              document.getElementById("createSettings").style.display = "none";
              document.getElementById("joinSettings").style.display = "flex";
              document.getElementById("blindtestSettings").style.display = "flex";
              document.getElementById("deafTestSettings").style.display = "none";
              document.getElementById("scattegoriesSettings").style.display = "none";
            };
          </script>
        </label>
        <label class="card" for="item-2" id="song-2">
          <img src="assets/img/Deaftest.png" alt="song" />
          <span class="card-text">DEAFTEST</span>
          <button id="creaDtBtn" class="hidden-btn crea" style="display:none;">Create</button>
          <script>
            document.getElementById("creaDtBtn").onclick = function () {
              document.getElementById("settingsPanel").style.display = "flex";
              document.getElementById("createSettings").style.display = "flex";
              document.getElementById("joinSettings").style.display = "none";
              document.getElementById("blindtestSettings").style.display = "none";
              document.getElementById("deafTestSettings").style.display = "flex";
              document.getElementById("scattegoriesSettings").style.display = "none";
            };
          </script>
          <button id="joinDtBtn" class="hidden-btn join" style="display:none;">Join</button>
          <script>
            document.getElementById("joinDtBtn").onclick = function () {
              document.getElementById("settingsPanel").style.display = "flex";
              document.getElementById("createSettings").style.display = "none";
              document.getElementById("joinSettings").style.display = "flex";
              document.getElementById("blindtestSettings").style.display = "none";
              document.getElementById("deafTestSettings").style.display = "flex";
              document.getElementById("scattegoriesSettings").style.display = "none";
            };
          </script>
        </label>
        <label class="card" for="item-3" id="song-3">
          <img src="assets/img/Scattegories.png" alt="song" />
          <span class="card-text">SCATTEGORIES</span>
          <button id="creaSgBtn" class="hidden-btn crea" style="display:none;">Create</button>
          <script>
            document.getElementById("creaSgBtn").onclick = function () {
              document.getElementById("settingsPanel").style.display = "flex";
              document.getElementById("createSettings").style.display = "flex";
              document.getElementById("joinSettings").style.display = "none";
              document.getElementById("blindtestSettings").style.display = "none";
              document.getElementById("deafTestSettings").style.display = "none";
              document.getElementById("scattegoriesSettings").style.display = "flex";
            };
          </script>
          <button id="joinSgBtn" class="hidden-btn join" style="display:none;">Join</button>
          <script>
            document.getElementById("joinSgBtn").onclick = function () {
              document.getElementById("settingsPanel").style.display = "flex";
              document.getElementById("createSettings").style.display = "none";
              document.getElementById("joinSettings").style.display = "flex";
              document.getElementById("blindtestSettings").style.display = "none";
              document.getElementById("deafTestSettings").style.display = "none";
              document.getElementById("scattegoriesSettings").style.display = "block";
            };
          </script>
        </label>
      </div>
      <button id="playButton">
        <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <filter id="neon-effect" x="-50%" y="-50%" width="200%" height="200%">
              <feFlood result="flood" flood-color="red" flood-opacity="0.5"></feFlood>
              <feComposite in="flood" result="mask" in2="SourceGraphic" operator="in"></feComposite>
              <feGaussianBlur in="mask" result="blurred" stdDeviation="1"></feGaussianBlur>
              <feMerge>
                <feMergeNode in="blurred"></feMergeNode>
                <feMergeNode in="SourceGraphic"></feMergeNode>
              </feMerge>
            </filter>
          </defs>
          <text x="20" y="150" font-family="'Press Start 2P'" font-size="90" font-weight="bold" letter-spacing="3" fill="red" filter="url(#neon-effect)" class="neon-letter">PLAY</text>
        </svg>
      </button>
    </div>
    <div id="settingsPanel" style="display: none;">
      <div id="settingsPanelClose">
        <button id="closeSettingsPanelBtn" class="btn-close" aria-label="Close"></button>
        <script>
          document.getElementById("closeSettingsPanelBtn").onclick = function () {
            document.getElementById("settingsPanel").style.display = "none";
          };
        </script>
      </div>
      <div id="createSettings" class="settings">
        <h1>Create a game</h1>
        
        <div id="commonSettings">
          <div id="gamenameSettings" class="setting">
            <label for="gameName" class="gameSettings">Game name:</label>
            <input type="text" id="gameName" name="gameName" />
          </div>
          <div id="roundsSettings" class="setting">
            <label for="rounds" class="gameSettings">Number of rounds:</label>
            <input type="number" id="rounds" name="rounds" min="1" max="10" />
          </div>
          <div id="roundDurationSettings" class="setting">
            <label for="roundDuration" class="gameSettings">Round duration (in seconds):</label>
            <input type="number" id="roundDuration" name="roundDuration" min="10" max="120" />
          </div>
          <div id="maxPlayersSettings" class="setting">
            <label for="maxPlayers" class="gameSettings">Max players:</label>
            <input type="number" id="maxPlayers" name="maxPlayers" min="1" max="10" />
          </div>
          <div id="categoriesSettings" class="setting">
            <label for="listCategories" class="gameSettings">Categories:</label>
            <input type="text" id="listCategories" name="listCategories" />
          </div>
        </div>

        <div id="blindtestSettings">
          <h2>BlindTest settings</h2>
        </div>
        <div id="deafTestSettings">
          <h2>DeafTest settings</h2>
        </div>
        <div id="scattegoriesSettings">
          <h2>Scattegories settings</h2>
        </div>
        <button id="createGame">Create</button>
        <script>
          document.getElementById("createGame").onclick = function () {
            var gameName = document.getElementById("gameName").value;
            var gameType = document.getElementsByClassName("checked")[0].id;
            var maxPlayers = document.getElementById("maxPlayers").value;
            var rounds = document.getElementById("rounds").value;
            var roundDuration = document.getElementById("roundDuration").value;
            var categories = document.getElementById("listCategories").value;

            

            if (gameType == "song-1") {
              gameType = "blindtest";
            } else if (gameType == "song-2") {
              gameType = "deaftest";
            } else if (gameType == "song-3") {
              gameType = "scattegories";
            }

            console.log("[DEBUG] gameName : " + gameName);
            console.log("[DEBUG] gameType : " + gameType);
            console.log("[DEBUG] maxPlayers : " + maxPlayers);
            console.log("[DEBUG] rounds : " + rounds);
            console.log("[DEBUG] roundDuration : " + roundDuration);
            console.log("[DEBUG] categories : " + categories);
            $.ajax({
              url: '/createRoom',
              type: 'POST',
              data: JSON.stringify({gameName: gameName, gameType: gameType, maxPlayers: maxPlayers, rounds: rounds, roundDuration: roundDuration, categories: categories}),
              success: function(response) {
                if (response.includes('success')) {
                  // Activer la room /joinRoom
                  console.log("[DEBUG] Game created");
                  console.log("[DEBUG] Response : " + response)
                  console.log("[DEBUG] Room ID : " + response.split(' ')[1])
                  time = 30000;
                  
                    $.ajax({
                      url: '/joinRoom',
                      type: 'POST',
                      data: JSON.stringify({gameCode: response.split(' ')[1]}),
                      success: function(response) {
                        if (response.includes('success')) {
                          console.log("[DEBUG] Game joined");
                          window.location.href = "/game";
                        } else {
                          console.log("[DEBUG] Game join failed");
                        }
                      }
                    });

                } else {
                  console.log("[DEBUG] Game creation failed");
                }
              }
            });
          };
        </script>
      </div>
      <div id="joinSettings" class="settings">
        <h1>Join a game</h1>
        <label for="gameCode">Game code:</label>
        <div id="gameCode" style="display: -ms-inline-grid; flex-direction: row; justify-content:space-around;">
          <button id="joinGameBtn">Join</button><input type="text" id="gameCodeInput" name="gameCode" /><div style="display: block;" id="ghostDiv"></div>
        </div>
        <span id="gameCodeError" style="display:none;">Game code not valid</span>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            document.getElementById(('joinGameBtn')).addEventListener('click', function() {
              var roomID = document.getElementById('gameCode').value;
              $.ajax({
                url: '/joinRoom',
                type: 'POST',
                data: JSON.stringify({roomID: roomID}),
                success: function(response) {
                  if (response.includes('success')) {
                    console.log("[DEBUG] Game joined");
                    window.location.href = "/game";
                  } else {
                    console.log("[DEBUG] Game join failed");
                  }
                }
              });
            });
          });

          document.addEventListener('DOMContentLoaded', function() {
            document.getElementById(('gameCodeInput')).addEventListener('input', function(e) {
              
              var gameCode = document.getElementById('gameCodeInput').value;
              $.ajax({
                url: '/controlCode',
                type: 'POST',
                data: JSON.stringify({gameCode: gameCode}),
                success: function(response) {
                  if (response == 'ok') {
                    document.getElementById('joinGameBtn').disabled = false;
                    document.getElementById('gameCodeError').style.display = 'none';
                    document.getElementById('joinGameBtn').style.backgroundColor = 'green';
                  } else if (response == 'inexistent') {
                    document.getElementById('gameCodeError').style.display = 'block';
                    document.getElementById('joinGameBtn').disabled = true;
                    document.getElementById('joinGameBtn').style.backgroundColor = 'grey';
                    document.getElementById('gameCodeError').innerHTML = 'Game code not valid';
                  } else if (response == 'full') {
                    document.getElementById('gameCodeError').style.display = 'block';
                    document.getElementById('joinGameBtn').disabled = true;
                    document.getElementById('joinGameBtn').style.backgroundColor = 'grey';
                    document.getElementById('gameCodeError').innerHTML = 'Game is full';
                  }
                }
              });
            });
          });
        </script>
      </div>
    </div>
  </body>
  <script>
    $(document).ready(function() {
      $('#playButton').click(function() {
        $('.card-text').removeClass('text-up');
        $('.hidden-btn').hide().removeClass('btn-show');

        var selectedCardId = $('input[type=radio][name=slider]:checked').attr('id');
        var cardSelector = 'label[for=' + selectedCardId + ']';
        
        var text = $(cardSelector + ' .card-text');
        var buttons = $(cardSelector + ' .hidden-btn');

        $('.card').removeClass('checked');
        $(cardSelector).addClass('checked');
        
        text.addClass('text-up');
        buttons.show().addClass('btn-show');
      });

      $('input[type=radio][name=slider]').change(function() {
        $('.card-text').removeClass('text-up');
        $('.hidden-btn').hide().removeClass('btn-show');
      });
    });
  </script>
</html>